import{n as v,o as u,a as h,l as r,t as n}from"./index.e8c38c50.js";const m={name:"Chat",data(){return{selectedRoom:0,messageInput:"",chatRooms:[],createSheet:!1,inviteSheet:!1,createRoomName:"",createRoomDesc:"",projectPopulation:[],selectedPopulation:[],expelledPopulation:[],inviteNominees:u(()=>this.projectPopulation.filter((s,e)=>this.chatRooms[this.selectedRoom].users.find((t,o)=>t.userId===s.peopleId)===void 0)),inviteSelected:[]}},inject:{user:{default:null},proj:{default:null}},created(){this.updateChatRooms(),this.updatePopulation()},methods:{getIdenticon:h,updateChatRooms(){console.log("updating chat rooms...");let s={},e={};this.chatRooms.forEach((t,o)=>{t.ws!==null&&(s[t.id]=t.ws,e[t.id]=t.history)}),this.chatRooms=[],r.post("/api/chat/discussions",{projectId:this.proj.projectId,userId:this.user.id}).then(t=>{if(console.log(t.data),t.data.errcode===0){let o=t.data.data.discussions.map((i,l)=>({id:i.roomId,title:i.roomName,desc:i.outline,users:i.users,history:[]}));console.log(o);let a={};o.forEach((i,l)=>{a[i.id]===void 0&&(a[i.id]=i)}),this.chatRooms=Object.values(a),console.log(o)}else throw new Error("get discussion list failure with non 0 errcode ("+t.data.errcode+")")}).catch(t=>{this.chatRooms=[],console.error(t),this.$message({type:"error",message:"get discussion list failure with error: "+t})}).finally(()=>{this.chatRooms.forEach((t,o)=>{s[t.id]!==void 0?(t.ws=s[t.id],s[t.id]=void 0,t.history=e[t.id]):(t.ws=this.initWS(t.id),this.getChatHistory(t))});for(const[t,o]of Object.entries(s))o!==void 0&&o.close()})},createChatRoom(){if(this.createRoomName===""){this.$message({type:"warning",message:"\u8BF7\u8F93\u5165\u804A\u5929\u5BA4\u540D\u79F0"});return}else if(this.createRoomDesc===""){this.$message({type:"warning",message:"\u8BF7\u8F93\u5165\u804A\u5929\u5BA4\u7B80\u4ECB"});return}let s=this.selectedPopulation.map((e,t)=>e.peopleId);r.post("/api/chat/createRoom",{projectId:this.proj.projectId,roomName:this.createRoomName,outline:this.createRoomDesc,currentUserId:this.user.id,users:s}).finally(()=>{this.updateChatRooms()}),this.createRoomName="",this.createRoomDesc="",this.selectedPopulation=[],this.expelledPopulation=this.projectPopulation,this.createSheet=!1},getChatHistory(s){r.post("/api/chat/getRoomMessages",{roomId:s.id}).then(e=>{if(console.log(e.data),s.history=[],e.data.errcode===0){e.data.data.messages.reverse().map((o,a)=>{s.history.push({from:o.senderName,content:o.content,time:o.time,type:"group"})});let t={};s.history.forEach((o,a)=>{t[o.time]===void 0&&(t[o.time]=o)}),s.history=Object.values(t)}else throw new Error("get room messages failure with non 0 errcode ("+e.data.errcode+")")}).catch(e=>{console.error(e),this.$message({type:"error",message:"get room messages failure with error: "+e})})},inviteUserToChat(s,e){r.post("/api/chat/addPerson",{roomId:s,userId:e}).then(t=>{console.log(t)}).finally(()=>{this.inviteSheet=!1,this.updateChatRooms()})},updatePopulation(){r.post("/api/plan/showPersonList",{projectId:this.proj.projectId,userId:this.user.id}).then(s=>{if(s.data.errcode!==0)throw new Error("get person list failure with non 0 errcode ("+s.data.errcode+")");this.projectPopulation=s.data.data.filter((e,t)=>e.peopleId!==this.user.id),this.expelledPopulation=s.data.data.filter((e,t)=>e.peopleId!==this.user.id),console.log(s.data.data)}).catch(s=>{console.error(s),this.$message({type:"error",message:"get person list failure with error: "+s})})},initWS(s){console.log("initWS: connecting to ws://104.208.78.33:8000/ws/chat/"+this.user.id.toString()+"/"+s.toString());const e=new WebSocket("ws://104.208.78.33:8000/ws/chat/"+this.user.id.toString()+"/"+s.toString()),t=a=>{console.log("socket opened")};e.onopen=t;const o=(a,i,l,d)=>{let c=this.chatRooms.find((p,y)=>p.id===s);c===void 0?console.error("room not found"):c.history.splice(0,0,{from:a,type:"group",content:l,time:d})};return e.onmessage=function(a){console.log("Message from server ",a.data);var i=JSON.parse(a.data);o(i.senderName,i.senderId,i.content,i.time)},e.onerror=function(a){console.error("WebSocket error observed:",a)},e.onclose=function(a){console.log("Socket is closed.",a.reason)},e},sendMsg(){if((this.messageInput||"").length>80){this.$message({type:"error",message:"\u6D88\u606F\u592A\u957F\u4E86"});return}console.log("will send: "+this.messageInput),this.chatRooms[this.selectedRoom].ws.send(JSON.stringify({sender:this.user.id,type:1,message:this.messageInput})),this.messageInput=""},getDarkColor:n.getDarkColor,getTopicColor:n.getColor,getLinearGradient:n.getLinearGradient,getRadialGradient:n.getRadialGradient},beforeRouteLeave(s,e,t){console.log("leaving chat room, closing all ws"),this.chatRooms.forEach((o,a)=>{o.ws.close()}),t()}};var g=function(){var e=this,t=e._self._c;return t("v-container",[t("h1",[e._v("\u804A\u5929\u5BA4")]),t("v-row",[t("v-col",{attrs:{cols:"3"}},[t("v-list",[t("v-list-item-group",{attrs:{mandatory:""},model:{value:e.selectedRoom,callback:function(o){e.selectedRoom=o},expression:"selectedRoom"}},e._l(e.chatRooms,function(o){return t("v-list-item",{key:o.id,attrs:{"two-line":""}},[t("v-list-item-content",[t("v-list-item-title",{staticStyle:{"font-weight":"bold"}},[t("span",{style:"color: "+e.getDarkColor(e.user.topic)},[e._v(e._s(o.title))]),e._v(" "),t("span",{staticClass:"float-end grey--text"},[e._v(e._s(o.desc))])]),t("v-list-item-subtitle",[e._v(" "+e._s(o.history.length===0?"\u8FD8\u6CA1\u6709\u6D88\u606F\u54E6":o.history[0].from+" : "+o.history[0].content)+" "),t("span",{staticClass:"float-end"},[e._v(e._s(o.history.length===0?"":new Date(o.history[0].time).toLocaleTimeString()))])])],1)],1)}),1),t("v-divider"),t("v-list-item",{attrs:{ripple:""},on:{click:function(o){e.createSheet=!e.createSheet}}},[t("v-list-item-content",[t("span",{style:"color: "+e.getDarkColor(e.user.topic)},[e._v("\u521B\u5EFA\u65B0\u7684\u804A\u5929\u5BA4")])]),t("v-list-item-icon",[t("v-icon",{attrs:{color:e.getDarkColor(e.user.topic)}},[e._v("mdi-plus-circle")])],1)],1),t("v-dialog",{model:{value:e.createSheet,callback:function(o){e.createSheet=o},expression:"createSheet"}},[t("v-card",[t("v-card-title",[e._v(" \u521B\u5EFA\u65B0\u7684\u804A\u5929\u5BA4 ")]),t("v-card-text",[t("v-row",[t("v-spacer"),t("v-col",{attrs:{cols:"5"}},[t("v-text-field",{attrs:{label:"\u804A\u5929\u5BA4\u540D\u79F0"},model:{value:e.createRoomName,callback:function(o){e.createRoomName=o},expression:"createRoomName"}})],1),t("v-col",{attrs:{cols:"5"}},[t("v-text-field",{attrs:{label:"\u804A\u5929\u5BA4\u7B80\u4ECB"},model:{value:e.createRoomDesc,callback:function(o){e.createRoomDesc=o},expression:"createRoomDesc"}})],1),t("v-spacer")],1),t("v-row",[t("v-spacer"),t("v-col",{attrs:{cols:"5"}},[e._v(" \u4ECE\u53F3\u8FB9\u9009\u62E9\u804A\u5929\u5BA4\u6210\u5458 "),t("v-chip",{staticClass:"ma-2 accent-1",attrs:{pill:"",color:"green"},on:{click:()=>{this.$message({type:"error",message:"\u628A\u81EA\u5DF1\u8E22\u51FA\u804A\u5929\u5BA4\uFF0C\u8FD9\u4E5F\u592A\u72E0\u4E86\uFF01"})}}},[t("v-avatar",{attrs:{left:""}},[t("v-img",{attrs:{src:e.getIdenticon(e.user.name,50,"user")}})],1),e._v(" \u60A8 ")],1),e._l(e.selectedPopulation,function(o){return t("v-chip",{key:o.peopleId,staticClass:"ma-2 accent-1",attrs:{color:"green"},on:{click:()=>{e.expelledPopulation.push(o),e.selectedPopulation.splice(e.selectedPopulation.indexOf(o),1)}}},[t("v-avatar",{attrs:{left:""}},[t("v-img",{attrs:{src:e.getIdenticon(o.peopleName,50,"user")}})],1),e._v(" "+e._s(o.peopleName)+" ")],1)})],2),t("v-col",{attrs:{cols:"5"}},[e.expelledPopulation.length!==0?t("span",[e._v("\u4E0D\u5728\u804A\u5929\u5BA4\u7684\u6210\u5458\uFF1A")]):t("span",[e._v("\u5927\u5BB6\u90FD\u5728\u804A\u5929\u5BA4\u91CC\u4E86\u54E6")]),e._l(e.expelledPopulation,function(o){return t("v-chip",{key:o.peopleId,staticClass:"ma-2",on:{click:()=>{e.selectedPopulation.push(o),e.expelledPopulation.splice(e.expelledPopulation.indexOf(o),1)}}},[t("v-avatar",{attrs:{left:""}},[t("v-img",{attrs:{src:e.getIdenticon(o.peopleName,50,"user")}})],1),e._v(" "+e._s(o.peopleName)+" ")],1)})],2),t("v-spacer")],1)],1),t("v-card-actions",[t("v-spacer"),t("v-btn",{attrs:{plain:"",color:e.getDarkColor(e.user.topic)},on:{click:e.createChatRoom}},[e._v("\u521B\u5EFA\uFF01")])],1)],1)],1)],1)],1),t("v-col",{attrs:{cols:"9"}},[e.chatRooms.length>0?t("v-row",[t("v-col",{attrs:{cols:"12"}},[t("v-card",[t("v-card-title",{staticClass:"v-app-bar-title"},[e._v(e._s(e.chatRooms[e.selectedRoom].title))]),t("v-card-subtitle",[this.chatRooms[this.selectedRoom].ws!==void 0&&this.chatRooms[this.selectedRoom].ws.readyState===1?t("v-icon",{staticClass:"green--text"},[e._v("mdi-circle")]):t("v-icon",{staticClass:"yellow--text"},[e._v("mdi-circle")]),e._v(" ws://104.208.78.33:8000/ws/chat/"+e._s(this.user.id)+"/"+e._s(e.chatRooms[e.selectedRoom].id)+" | "+e._s(e.chatRooms[e.selectedRoom].desc)+" ")],1),t("v-card-text",[e._l(e.chatRooms[e.selectedRoom].users,function(o){return t("v-hover",{key:o.userId,scopedSlots:e._u([{key:"default",fn:function({hover:a}){return[t("span",[t("v-avatar",{staticClass:"mx-1",attrs:{size:"50px"}},[t("v-img",{attrs:{alt:o.username,src:e.getIdenticon(o.userName,50,"user")}})],1),t("Transition",[a?t("p",{staticClass:"px-2 text-h5 d-inline-block",staticStyle:{"font-weight":"bold"}},[e._v(e._s(o.userName))]):e._e()])],1)]}}],null,!0)})}),t("v-avatar",{staticClass:"mx-1 float-end"},[t("v-icon",{attrs:{size:"50px",color:e.getDarkColor(e.user.topic)},on:{click:function(o){e.inviteSheet=!e.inviteSheet}}},[e._v("mdi-plus-circle")])],1)],2)],1)],1),t("v-dialog",{model:{value:e.inviteSheet,callback:function(o){e.inviteSheet=o},expression:"inviteSheet"}},[t("v-card",[t("v-card-title",[e._v("\u9080\u8BF7\u65B0\u6210\u5458\u52A0\u5165\u804A\u5929\u5BA4")]),e.inviteNominees.length!==0?t("v-card-text",[t("v-chip-group",{attrs:{mandatory:"","active-class":"primary--text"},model:{value:e.inviteSelected,callback:function(o){e.inviteSelected=o},expression:"inviteSelected"}},e._l(e.inviteNominees,function(o){return t("v-chip",{key:o.peopleId,staticClass:"ma-2",on:{click:()=>{e.expelledPopulation.push(o),e.selectedPopulation.splice(e.selectedPopulation.indexOf(o),1)}}},[t("v-avatar",{attrs:{left:""}},[t("v-img",{attrs:{src:e.getIdenticon(o.peopleName,50,"user")}})],1),e._v(" "+e._s(o.peopleName)+" ")],1)}),1),t("v-divider"),e.inviteNominees[e.inviteSelected]!==void 0?t("v-card-subtitle",[e._v("\u8981\u9080\u8BF7 "+e._s(e.inviteNominees[e.inviteSelected].peopleName)+" \u8FDB\u5165\u7FA4\u804A\u201C"+e._s(e.chatRooms[e.selectedRoom].title)+"\u201D\u5417\uFF1F")]):e._e(),t("v-card-actions",[t("v-btn",{attrs:{plain:"",color:e.getDarkColor(e.user.topic)},on:{click:()=>e.inviteUserToChat(e.chatRooms[e.selectedRoom].id,e.inviteNominees[e.inviteSelected].peopleId)}},[e._v("\u786E\u5B9A\u9080\u8BF7")]),t("v-btn",{staticClass:"red--text",attrs:{plain:""},on:{click:()=>e.inviteSheet=!e.inviteSheet}},[e._v("\u6211\u518D\u60F3\u60F3")])],1)],1):t("v-card-text",[t("v-card-subtitle",[e._v("\u9879\u76EE\u6240\u6709\u7684\u6210\u5458\u90FD\u5728\u804A\u5929\u5BA4\u91CC\u4E86\uFF01")]),t("v-card-actions",[t("v-btn",{attrs:{plain:"",color:e.getDarkColor(e.user.topic)},on:{click:()=>e.inviteSheet=!e.inviteSheet}},[e._v("\u597D")])],1)],1)],1)],1)],1):e._e(),e.chatRooms.length>0?t("v-row",[t("v-col",{attrs:{cols:"12"}},[t("v-card",[t("v-card-text",[t("v-row",[t("v-spacer"),t("v-col",{attrs:{cols:"10"}},[t("v-text-field",{attrs:{rounded:"",filled:"",counter:"80",label:"\u8F93\u5165\u6D88\u606F","append-outer-icon":"mdi-send"},on:{"click:append-outer":e.sendMsg,keydown:function(o){return!o.type.indexOf("key")&&e._k(o.keyCode,"enter",13,o.key,"Enter")?null:e.sendMsg.apply(null,arguments)}},model:{value:e.messageInput,callback:function(o){e.messageInput=o},expression:"messageInput"}})],1),t("v-spacer")],1),t("v-list",{staticClass:"overflow-auto scroll-y",attrs:{"min-height":"600","max-height":"600"}},[t("v-list-item-group",[e._l(e.chatRooms[e.selectedRoom].history,function(o){return[t("v-divider",{key:o.id}),e.user.name!==o.from?t("v-list-item",{key:o.id,attrs:{disabled:"","two-line":""}},[t("v-list-item-avatar",{attrs:{size:"40px"}},[t("v-img",{attrs:{src:e.getIdenticon(o.from,50,"user")}})],1),t("v-list-item-content",[t("v-list-item-title",{staticClass:"text--primary",staticStyle:{"font-weight":"bold","font-size":"large"}},[e._v(e._s(o.content))]),t("v-list-item-subtitle",[e._v(e._s(o.from)),t("span",{staticClass:"float-end"},[e._v(e._s(new Date(o.time).toLocaleTimeString()))])])],1)],1):t("v-list-item",{key:o.id,style:e.getLinearGradient(e.user.topic),attrs:{disabled:"","two-line":""}},[t("v-list-item-content",[t("v-list-item-title",{staticClass:"text--primary",staticStyle:{"font-weight":"bold","font-size":"large"}},[t("span",{staticClass:"float-end"},[e._v(e._s(o.content))])]),t("v-list-item-subtitle",[e._v(e._s(new Date(o.time).toLocaleTimeString())),t("span",{staticClass:"float-end"},[e._v("\u60A8")])])],1),t("v-list-item-avatar",{attrs:{size:"40px"}},[t("v-img",{attrs:{src:e.getIdenticon(o.from,50,"user")}})],1)],1)]})],2)],1)],1)],1)],1)],1):t("v-row",[t("v-col",{attrs:{cols:"12"}},[t("v-card",[t("v-card-title",[e._v("\u8FD8\u6CA1\u6709\u8BA8\u8BBA\u5BA4\u54E6")]),t("v-card-text",[t("v-card-actions",[t("v-btn",{staticClass:"green--text accent-1",attrs:{plain:""},on:{click:function(o){e.createSheet=!e.createSheet}}},[e._v("\u53BB\u521B\u5EFA\uFF01")])],1)],1)],1)],1)],1)],1)],1)],1)},f=[],_=v(m,g,f,!1,null,null,null,null);const x=_.exports;export{x as default};
