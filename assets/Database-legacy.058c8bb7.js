System.register(["./index-legacy.784821ab.js"],(function(t,e){"use strict";var n,i,l,o=document.createElement("style");return o.textContent="",document.head.appendChild(o),{setters:[function(t){n=t.n,i=t.l,l=t.t}],execute:function(){var e={name:"Database",inject:["user","proj"],data:function(){return{entries:{},uploadDialog:!1,fileInput:null,fileNameInput:"",fileExtInput:"",fileMajorInput:0,fileMinorInput:0,filePatchInput:0,changeNameAllow:!0,minPatch:-1}},methods:{upload:function(){var t=this;console.log(this.fileInput),console.log(this.fileNameInput),console.log(this.fileExtInput),console.log(this.fileMajorInput),console.log(this.fileMinorInput),console.log(this.filePatchInput),console.log((new Date).getTime()),console.log("".concat(this.fileNameInput,"-").concat((new Date).getTime(),"-").concat(this.fileMajorInput,"-").concat(this.fileMinorInput,"-").concat(this.filePatchInput,".").concat(this.fileExtInput)),this.fileInput=new File([this.fileInput],"".concat(this.fileNameInput,"-").concat((new Date).getTime(),"-").concat(this.fileMajorInput,"-").concat(this.fileMinorInput,"-").concat(this.filePatchInput,".").concat(this.fileExtInput),{type:this.fileInput.type});var e=new FormData;e.append("projectId",this.proj.projectId),e.append("file",this.fileInput),i({method:"post",maxBodyLength:1/0,url:"/api/file/uploadFile",data:e}).then((function(e){console.log(JSON.stringify(e.data)),t.$message.success("上传文件成功")})).catch((function(e){console.log(e),t.$message.error("上传文件失败")})).finally((function(){t.updateDatabase(),t.uploadDialog=!1}))},download:function(t){var e=this;console.log(t);var n=t.fullname;i.post("/api/file/downloadFile",{projectId:this.proj.projectId,fileName:n},{responseType:"blob"}).then((function(n){var i=new Blob([n.data]),l=URL.createObjectURL(i),o=document.createElement("a");o.href=l,o.setAttribute("download",t.name+t.ext),document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(l),e.$message.success("下载文件成功，请检查浏览器下载页面")})).catch((function(t){e.$message.error("下载文件失败"),console.log(t)}))},mapFileToEntry:function(t){var e="."+t.split(".").pop(),n=t.split(".").slice(0,-1).join(".").split("-");return 5!==n.length?(console.log(t+" does not seem to be a valid file in jihub database, skipping..."),null):{name:n[0],ext:e,time:new Date(parseInt(n[1])),major:parseInt(n[2]),minor:parseInt(n[3]),patch:parseInt(n[4]),fullname:t}},updateDatabase:function(){var t=this;i.post("/api/file/watchFiles",{projectId:this.proj.projectId}).then((function(e){if(console.log(e),0!==e.data.errcode)throw new Error;var n={};e.data.data.forEach((function(e){var i=t.mapFileToEntry(e.name);null!==i&&(void 0===n[i.name+i.ext]?(n[i.name+i.ext]={expand:!1,files:[]},n[i.name+i.ext].files.push(i)):n[i.name+i.ext].files.push(i))})),t.entries=n})).catch((function(e){t.$message.error("获取文件列表失败"),console.log(e)}))},initUploadDialog:function(t,e){if(null===t)this.fileInput=null,this.fileNameInput="",this.fileExtInput="",this.changeNameAllow=!0,this.fileMajorInput=0,this.fileMinorInput=0,this.filePatchInput=0,this.uploadDialog=!0,this.minPatch=-1;else{console.log("non null selected entry: ",t,e),this.fileInput=null,this.fileNameInput=e.split(".").slice(0,-1).join("."),this.fileExtInput=e.split(".").pop(),this.changeNameAllow=!1,this.fileMajorInput=0,this.fileMinorInput=0,this.filePatchInput=0,this.uploadDialog=!0;var n=t.files[t.files.length-1];this.minPatch=1e6*n.major+1e3*n.minor+n.patch,console.log("min vercode",this.minPatch)}},onFileInput:function(){console.log("on file input"),void 0!==this.fileInput&&null!==this.fileInput&&this.fileInput.size>=5e7&&(this.$msgbox("文件大小超过50MB，JiHub暂时不支持过大的文件上传","文件过大"),this.fileInput=null),this.changeNameAllow&&-1!==Object.keys(this.entries).indexOf(this.fileInput.name)&&(this.$msgbox("重复文件，请检查数据库","重复文件"),this.fileInput=null),this.changeNameAllow?(this.fileNameInput=void 0===this.fileInput?"":this.fileInput.name.split(".").slice(0,-1).join("."),this.fileExtInput=void 0===this.fileInput?"":this.fileInput.name.split(".").pop()):void 0===this.fileInput||this.fileInput.name.split(".").slice(0,-1).join(".")===this.fileNameInput&&this.fileInput.name.split(".").pop()===this.fileExtInput||this.$msgbox("选择的文件与文件系列名不同，请注意检查","文件名不同"),this.changeNameAllow&&void 0!==this.fileInput&&-1!==this.fileInput.name.indexOf("-")&&this.$msgbox("选中的文件名含有'-'，不过，您可以在JiHub修改此文件名","含有非法符号")},getTopicColor:l.getColor,getDarkColor:l.getDarkColor,getLinearGradient:l.getLinearGradient,getRadialGradient:l.getRadialGradient,checkLeadingZero:function(t){return"0"===t||"0"===t[0]}},created:function(){this.updateDatabase()}};t("default",n(e,(function(){var t=this,e=t._self._c;return e("v-container",[e("v-row",[e("v-col",{attrs:{cols:"12"}},[e("h1",{style:"color: "+t.getDarkColor(t.user.topic)},[t._v("团队数据库")])])],1),e("v-row",[t._l(t.entries,(function(n,i){return[e("v-col",{attrs:{cols:n.expand?12:4}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function(l){var o=l.hover;return[e("v-card",{style:o?t.getRadialGradient(t.user.topic):"",attrs:{"min-height":"13rem"}},[e("v-card-title",[e("strong",{style:"color: "+t.getDarkColor(t.user.topic)},[t._v(t._s(i))])]),e("v-card-text",[e("div",[t._v("最新版本："),e("span",{staticClass:"float-end"},[t._v(t._s(n.files[n.files.length-1].major)+"."+t._s(n.files[n.files.length-1].minor)+"."+t._s(n.files[n.files.length-1].patch))])]),e("div",[t._v("最新更新："),e("span",{staticClass:"float-end"},[t._v(t._s(n.files[n.files.length-1].time.toLocaleString()))])]),e("div",[t._v("共有："),e("span",{staticClass:"float-end"},[t._v(t._s(n.files.length)+" 次上传")])])]),e("v-card-actions",[e("v-btn",{attrs:{plain:""},on:{click:function(){return t.initUploadDialog(n,i)}}},[t._v("上传新版本")]),e("v-spacer"),e("v-btn",{attrs:{plain:""},on:{click:function(){return t.download(n.files[n.files.length-1])}}},[t._v("下载最新版本")]),e("v-btn",{attrs:{plain:""},on:{click:function(t){n.expand=!n.expand}}},[t._v(t._s(n.expand?"收回":"展开"))])],1),e("v-expand-transition",[e("div",{directives:[{name:"show",rawName:"v-show",value:n.expand,expression:"entry.expand"}]},[e("v-divider"),e("v-card-text",[e("v-timeline",{attrs:{dense:""}},[t._l(n.files,(function(n){return e("v-timeline-item",{key:n.time.getTime(),attrs:{color:t.getTopicColor(t.user.topic)}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function(i){var l=i.hover;return[e("v-card",{style:"transition-duration: 0.5s;"+(l?t.getLinearGradient(t.user.topic):"")},[e("v-card-title",[e("strong",{staticClass:"d-inline-block",style:"width: 10rem; color: "+t.getDarkColor(t.user.topic)},[t._v(t._s(n.major)+"."+t._s(n.minor)+"."+t._s(n.patch))]),e("strong",{staticClass:"grey--text"},[t._v("上传于："+t._s(n.time.toLocaleString()))]),e("v-spacer"),e("v-btn",{staticClass:"white--text",attrs:{color:t.getDarkColor(t.user.topic)},on:{click:function(){return t.download(n)}}},[t._v("下载")])],1)],1)]}}],null,!0)})],1)})),e("v-timeline-item",{attrs:{color:t.getTopicColor(t.user.topic),icon:"mdi-upload"}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function(l){var o=l.hover;return[e("v-card",{style:"transition-duration: 0.5s;"+(o?t.getLinearGradient(t.user.topic):""),on:{click:function(){return t.initUploadDialog(n,i)}}},[e("v-card-title",[e("strong",{staticClass:"d-inline-block",style:"width: 10rem; color: "+t.getDarkColor(t.user.topic)},[t._v("上传新版本")]),e("v-spacer")],1)],1)]}}],null,!0)})],1)],2)],1)],1)])],1)]}}],null,!0)})],1)]})),e("v-col",{attrs:{cols:"4"}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function(n){var i=n.hover;return[e("v-card",{style:i?t.getRadialGradient(t.user.topic):"",attrs:{"min-height":"13rem","max-height":"13rem"},on:{click:function(){return t.initUploadDialog(null)}}},[e("v-card-title",[e("strong",{style:"color: "+t.getDarkColor(t.user.topic)},[t._v("创建新的文件系列")])]),e("v-card-text",[t._v("上传一个文件，使用版本代码在JiHub上持续追溯，随时下载，项目成员也可上传最新进展")]),e("v-card-actions",[e("v-spacer"),e("v-btn",{attrs:{plain:""},on:{click:function(){return t.initUploadDialog(null)}}},[t._v("开始")])],1)],1)]}}])})],1)],2),e("v-dialog",{attrs:{persistent:""},model:{value:t.uploadDialog,callback:function(e){t.uploadDialog=e},expression:"uploadDialog"}},[e("v-card",[e("v-card-title",[t._v("上传文件")]),e("v-card-text",[e("v-form",[e("v-row",[e("v-col",{attrs:{cols:"6"}},[e("v-file-input",{attrs:{"truncate-length":"100","show-size":"",label:"上传文件",outlined:""},on:{change:t.onFileInput},model:{value:t.fileInput,callback:function(e){t.fileInput=e},expression:"fileInput"}})],1),e("v-col",{attrs:{cols:"4"}},[e("v-scroll-y-transition",[t.fileInput?e("v-text-field",{attrs:{disabled:!t.changeNameAllow,label:"文件系列名",rules:[function(t){return-1===t.indexOf("-")||"文件名不允许有'-'符号"}],"prepend-icon":"mdi-file",counter:"16",outlined:""},model:{value:t.fileNameInput,callback:function(e){t.fileNameInput=e},expression:"fileNameInput"}}):t._e()],1)],1),e("v-col",{attrs:{cols:"2"}},[e("v-scroll-y-transition",[t.fileInput?e("v-text-field",{attrs:{disabled:!t.changeNameAllow,label:"文件拓展名",rules:[function(t){return""!==t},function(t){return-1===t.indexOf(".")||"拓展名不允许'.'符号"}],"prepend-icon":"mdi-file",counter:"10",outlined:""},model:{value:t.fileExtInput,callback:function(e){t.fileExtInput=e},expression:"fileExtInput"}}):t._e()],1)],1)],1),e("v-row",[e("v-col",{attrs:{cols:"4"}},[e("v-scroll-y-transition",[t.fileInput&&""!==t.fileNameInput&&-1===t.fileNameInput.indexOf("-")&&t.fileNameInput.length<=16&&""!==t.fileExtInput&&t.fileExtInput.length<=10?e("v-text-field",{attrs:{label:"主版本号",rules:[function(t){return""!==t},function(t){return t>=0||"版本号必须为正整数"},function(t){return"0"===t||!t.startsWith("0")||"不允许前导零"},function(t){return t<=999||"版本号太大了"}],"prepend-icon":"mdi-file",counter:"3",outlined:""},model:{value:t.fileMajorInput,callback:function(e){t.fileMajorInput=e},expression:"fileMajorInput"}}):t._e()],1)],1),e("v-col",{attrs:{cols:"4"}},[e("v-scroll-y-transition",[t.fileInput&&""!==t.fileNameInput&&-1===t.fileNameInput.indexOf("-")&&t.fileNameInput.length<=16&&""!==t.fileExtInput&&t.fileExtInput.length<=10?e("v-text-field",{attrs:{label:"小版本号",rules:[function(t){return""!==t},function(t){return t>=0||"版本号必须为正整数"},function(t){return"0"===t||!t.startsWith("0")||"不允许前导零"},function(t){return t<=999||"版本号太大了"}],"prepend-icon":"mdi-file",counter:"3",outlined:""},model:{value:t.fileMinorInput,callback:function(e){t.fileMinorInput=e},expression:"fileMinorInput"}}):t._e()],1)],1),e("v-col",{attrs:{cols:"4"}},[e("v-scroll-y-transition",[t.fileInput&&""!==t.fileNameInput&&-1===t.fileNameInput.indexOf("-")&&t.fileNameInput.length<=16&&""!==t.fileExtInput&&t.fileExtInput.length<=10?e("v-text-field",{attrs:{label:"修订号",rules:[function(t){return""!==t},function(t){return t>=0||"版本号必须为正整数"},function(t){return"0"===t||!t.startsWith("0")||"不允许前导零"},function(t){return t<=999||"版本号太大了"}],"prepend-icon":"mdi-file",counter:"3",outlined:""},model:{value:t.filePatchInput,callback:function(e){t.filePatchInput=e},expression:"filePatchInput"}}):t._e()],1)],1)],1)],1)],1),t.fileInput&&""!==t.fileNameInput&&-1===t.fileNameInput.indexOf("-")&&t.fileNameInput.length<=16&&""!==t.fileExtInput&&t.fileExtInput.length<=10?[e("v-card-text",[e("v-card-title",[e("strong",[t._v(t._s(t.fileNameInput)+"."+t._s(t.fileExtInput))])]),e("v-timeline",{attrs:{dense:""}},[t.changeNameAllow?t._e():e("v-timeline-item",{attrs:{color:t.getTopicColor(t.user.topic)}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function(n){var i=n.hover;return[e("v-card",{style:"transition-duration: 0.5s;"+(i?t.getLinearGradient(t.user.topic):"")},[e("v-card-title",[e("strong",{staticClass:"d-inline-block",style:"width: 15rem; color: "+t.getDarkColor(t.user.topic)},[t._v(t._s(Math.floor(t.minPatch/1e6))+"."+t._s(Math.floor(t.minPatch/1e3%1e3))+"."+t._s(t.minPatch%1e3))]),e("strong",{staticClass:"grey--text"},[t._v("此前的版本")]),e("v-spacer"),e("v-btn",{staticClass:"white--text",attrs:{color:t.getDarkColor(t.user.topic),disabled:""}},[t._v("下载（不可用）")])],1)],1)]}}],null,!1,48090339)})],1),e("v-timeline-item",{attrs:{color:t.getTopicColor(t.user.topic),icon:"mdi-upload"}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function(n){var i=n.hover;return[e("v-card",{style:"transition-duration: 0.5s;"+(i?t.getLinearGradient(t.user.topic):"")},[e("v-card-title",[t.changeNameAllow||1e6*t.fileMajorInput+1e3*t.fileMinorInput+t.filePatchInput>t.minPatch?e("strong",{staticClass:"d-inline-block",style:"width: 15rem; color: "+t.getDarkColor(t.user.topic)},[t._v(t._s(t.fileMajorInput)+"."+t._s(t.fileMinorInput)+"."+t._s(t.filePatchInput))]):e("strong",{staticClass:"d-inline-block",style:"width: 15rem; color: red"},[t._v(t._s(t.fileMajorInput)+"."+t._s(t.fileMinorInput)+"."+t._s(t.filePatchInput)+"（过时或重复版本）")]),e("strong",{staticClass:"grey--text"},[t._v("上传于："+t._s((new Date).toLocaleString()))]),e("v-spacer"),e("v-btn",{staticClass:"white--text",attrs:{color:t.getDarkColor(t.user.topic),disabled:""}},[t._v("下载（不可用）")])],1)],1)]}}],null,!1,1410110661)})],1)],1)],1)]:t._e(),e("v-card-actions",[e("v-spacer"),e("v-btn",{attrs:{plain:"",color:"red"},on:{click:function(e){t.uploadDialog=!t.uploadDialog}}},[t._v("取消")]),e("v-btn",{attrs:{plain:"",color:t.getDarkColor(t.user.topic),disabled:!(t.fileInput&&""!==t.fileNameInput&&-1===t.fileNameInput.indexOf("-")&&t.fileNameInput.length<=16&&""!==t.fileExtInput&&t.fileExtInput.length<=10&&-1===t.fileExtInput.indexOf(".")&&(t.changeNameAllow||1e6*t.fileMajorInput+1e3*t.fileMinorInput+t.filePatchInput>t.minPatch)&&0<=t.fileMajorInput&&t.fileMajorInput<=999&&0<=t.fileMinorInput&&t.fileMinorInput<=999&&0<=t.filePatchInput&&t.filePatchInput<=999&&!t.checkLeadingZero(t.fileMajorInput)&&!t.checkLeadingZero(t.fileMinorInput)&&!t.checkLeadingZero(t.filePatchInput))},on:{click:t.upload}},[t._v("确定上传")])],1)],2)],1)],1)}),[],!1,null,"41230cb7",null,null).exports)}}}));
