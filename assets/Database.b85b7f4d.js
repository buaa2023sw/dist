import{n as p,l as u,t as s}from"./index.ee9eed85.js";const d={name:"Database",inject:["user","proj"],data(){return{entries:{},uploadDialog:!1,fileInput:null,fileNameInput:"",fileExtInput:"",fileMajorInput:0,fileMinorInput:0,filePatchInput:0,changeNameAllow:!0,minPatch:-1,downloading:!1,downloadProgressBannerContent:"Downloading...",uploading:!1,uploadProgressBannerContent:"Uploading..."}},methods:{upload(){this.uploading=!0,console.log(this.fileInput),console.log(this.fileNameInput),console.log(this.fileExtInput),console.log(this.fileMajorInput),console.log(this.fileMinorInput),console.log(this.filePatchInput),console.log(new Date().getTime()),console.log(`${this.fileNameInput}-${new Date().getTime()}-${this.fileMajorInput}-${this.fileMinorInput}-${this.filePatchInput}.${this.fileExtInput}`),this.fileInput=new File([this.fileInput],`${this.fileNameInput}-${new Date().getTime()}-${this.fileMajorInput}-${this.fileMinorInput}-${this.filePatchInput}.${this.fileExtInput}`,{type:this.fileInput.type});let l=new FormData;l.append("projectId",this.proj.projectId),l.append("file",this.fileInput);let t={method:"post",maxBodyLength:1/0,url:"/api/file/uploadFile",data:l,onUploadProgress:this.uploadProgressChanged};u(t).then(e=>{console.log(JSON.stringify(e.data)),this.$message.success("\u4E0A\u4F20\u6587\u4EF6\u6210\u529F")}).catch(e=>{console.log(e),this.$message.error("\u4E0A\u4F20\u6587\u4EF6\u5931\u8D25")}).finally(()=>{this.updateDatabase(),this.uploadDialog=!1,this.uploading=!1})},downloadProgressChanged(l){this.downloadProgressBannerContent=`Downloading... ${Math.round(l.loaded/l.total*100)}%`},uploadProgressChanged(l){this.uploadProgressBannerContent=`Uploading... ${Math.round(l.loaded/l.total*100)}%`},download(l){if(this.downloading===!0){this.$message.error("\u6B63\u5728\u4E0B\u8F7D\u6587\u4EF6\uFF0C\u8BF7\u5728\u5F53\u524D\u6587\u4EF6\u4E0B\u8F7D\u5B8C\u6210\u540E\u91CD\u8BD5");return}this.downloading=!0,console.log(l);const t=l.fullname;u.post("/api/file/downloadFile",{projectId:this.proj.projectId,fileName:t},{responseType:"blob",onDownloadProgress:this.downloadProgressChanged}).then(e=>{const i=new Blob([e.data]),a=URL.createObjectURL(i),o=document.createElement("a");o.href=a,o.setAttribute("download",l.name+l.ext),document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(a),this.$message.success("\u4E0B\u8F7D\u6587\u4EF6\u6210\u529F\uFF0C\u8BF7\u68C0\u67E5\u6D4F\u89C8\u5668\u4E0B\u8F7D\u9875\u9762")}).catch(e=>{this.$message.error("\u4E0B\u8F7D\u6587\u4EF6\u5931\u8D25"),console.log(e)}).finally(()=>{this.downloading=!1})},mapFileToEntry(l){const t="."+l.split(".").pop(),i=l.split(".").slice(0,-1).join(".").split("-");if(i.length!==5)return console.log(l+" does not seem to be a valid file in jihub database, skipping..."),null;{let a=i[0],o=new Date(parseInt(i[1])),n=parseInt(i[2]),r=parseInt(i[3]),c=parseInt(i[4]);return{name:a,ext:t,time:o,major:n,minor:r,patch:c,fullname:l}}},updateDatabase(){u.post("/api/file/watchFiles",{projectId:this.proj.projectId}).then(l=>{if(console.log(l),l.data.errcode!==0)throw new Error;let t={};l.data.data.forEach(e=>{let i=this.mapFileToEntry(e.name);i!==null&&(t[i.name+i.ext]===void 0&&(t[i.name+i.ext]={expand:!1,files:[]}),t[i.name+i.ext].files.push(i))}),this.entries=t}).catch(l=>{this.$message.error("\u83B7\u53D6\u6587\u4EF6\u5217\u8868\u5931\u8D25"),console.log(l)})},initUploadDialog(l,t){if(l===null)this.fileInput=null,this.fileNameInput="",this.fileExtInput="",this.changeNameAllow=!0,this.fileMajorInput=0,this.fileMinorInput=0,this.filePatchInput=0,this.uploadDialog=!0,this.minPatch=-1;else{console.log("non null selected entry: ",l,t),this.fileInput=null,this.fileNameInput=t.split(".").slice(0,-1).join("."),this.fileExtInput=t.split(".").pop(),this.changeNameAllow=!1,this.fileMajorInput=0,this.fileMinorInput=0,this.filePatchInput=0,this.uploadDialog=!0;let e=l.files[l.files.length-1];this.minPatch=1e6*e.major+1e3*e.minor+e.patch,console.log("min vercode",this.minPatch)}},onFileInput(){console.log("on file input"),this.fileInput!==void 0&&this.fileInput!==null&&this.fileInput.size>=5e7&&(this.$msgbox("\u6587\u4EF6\u5927\u5C0F\u8D85\u8FC750MB\uFF0CJiHub\u6682\u65F6\u4E0D\u652F\u6301\u8FC7\u5927\u7684\u6587\u4EF6\u4E0A\u4F20","\u6587\u4EF6\u8FC7\u5927"),this.fileInput=null),this.changeNameAllow&&Object.keys(this.entries).indexOf(this.fileInput.name)!==-1&&(this.$msgbox("\u91CD\u590D\u6587\u4EF6\uFF0C\u8BF7\u68C0\u67E5\u6570\u636E\u5E93","\u91CD\u590D\u6587\u4EF6"),this.fileInput=null),this.changeNameAllow?(this.fileNameInput=this.fileInput===void 0?"":this.fileInput.name.split(".").slice(0,-1).join("."),this.fileExtInput=this.fileInput===void 0?"":this.fileInput.name.split(".").pop()):this.fileInput!==void 0&&(this.fileInput.name.split(".").slice(0,-1).join(".")!==this.fileNameInput||this.fileInput.name.split(".").pop()!==this.fileExtInput)&&this.$msgbox("\u9009\u62E9\u7684\u6587\u4EF6\u4E0E\u6587\u4EF6\u7CFB\u5217\u540D\u4E0D\u540C\uFF0C\u8BF7\u6CE8\u610F\u68C0\u67E5","\u6587\u4EF6\u540D\u4E0D\u540C"),this.changeNameAllow&&this.fileInput!==void 0&&this.fileInput.name.indexOf("-")!==-1&&this.$msgbox("\u9009\u4E2D\u7684\u6587\u4EF6\u540D\u542B\u6709'-'\uFF0C\u4E0D\u8FC7\uFF0C\u60A8\u53EF\u4EE5\u5728JiHub\u4FEE\u6539\u6B64\u6587\u4EF6\u540D","\u542B\u6709\u975E\u6CD5\u7B26\u53F7")},getTopicColor:s.getColor,getDarkColor:s.getDarkColor,getLinearGradient:s.getLinearGradient,getRadialGradient:s.getRadialGradient,checkLeadingZero(l){return l==="0"?!0:l[0]==="0"}},created(){this.updateDatabase()}};var f=function(){var t=this,e=t._self._c;return e("v-container",[e("v-snackbar",{staticClass:"white--text",attrs:{timeout:"-1",color:t.getDarkColor(t.user.topic)},model:{value:t.downloading,callback:function(i){t.downloading=i},expression:"downloading"}},[t._v(t._s(t.downloadProgressBannerContent))]),e("v-snackbar",{staticClass:"white--text",attrs:{timeout:"-1",color:t.getDarkColor(t.user.topic)},model:{value:t.uploading,callback:function(i){t.uploading=i},expression:"uploading"}},[t._v(t._s(t.uploadProgressBannerContent))]),e("v-row",[e("v-col",{attrs:{cols:"12"}},[e("h1",{style:"color: "+t.getDarkColor(t.user.topic)},[t._v("\u56E2\u961F\u6570\u636E\u5E93")])])],1),e("v-row",[t._l(t.entries,function(i,a){return[e("v-col",{attrs:{cols:i.expand?12:4}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function({hover:o}){return[e("v-card",{style:o?t.getRadialGradient(t.user.topic):"",attrs:{"min-height":"13rem"}},[e("v-card-title",[e("strong",{style:"color: "+t.getDarkColor(t.user.topic)},[t._v(t._s(a))])]),e("v-card-text",[e("div",[t._v("\u6700\u65B0\u7248\u672C\uFF1A"),e("span",{staticClass:"float-end"},[t._v(t._s(i.files[i.files.length-1].major)+"."+t._s(i.files[i.files.length-1].minor)+"."+t._s(i.files[i.files.length-1].patch))])]),e("div",[t._v("\u6700\u65B0\u66F4\u65B0\uFF1A"),e("span",{staticClass:"float-end"},[t._v(t._s(i.files[i.files.length-1].time.toLocaleString()))])]),e("div",[t._v("\u5171\u6709\uFF1A"),e("span",{staticClass:"float-end"},[t._v(t._s(i.files.length)+" \u6B21\u4E0A\u4F20")])])]),e("v-card-actions",[e("v-btn",{attrs:{plain:""},on:{click:()=>t.initUploadDialog(i,a)}},[t._v("\u4E0A\u4F20\u65B0\u7248\u672C")]),e("v-spacer"),e("v-btn",{attrs:{plain:""},on:{click:()=>t.download(i.files[i.files.length-1])}},[t._v("\u4E0B\u8F7D\u6700\u65B0\u7248\u672C")]),e("v-btn",{attrs:{plain:""},on:{click:function(n){i.expand=!i.expand}}},[t._v(t._s(i.expand?"\u6536\u56DE":"\u5C55\u5F00"))])],1),e("v-expand-transition",[e("div",{directives:[{name:"show",rawName:"v-show",value:i.expand,expression:"entry.expand"}]},[e("v-divider"),e("v-card-text",[e("v-timeline",{attrs:{dense:""}},[t._l(i.files,function(n){return e("v-timeline-item",{key:n.time.getTime(),attrs:{color:t.getTopicColor(t.user.topic)}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function({hover:r}){return[e("v-card",{style:"transition-duration: 0.5s;"+(r?t.getLinearGradient(t.user.topic):"")},[e("v-card-title",[e("strong",{staticClass:"d-inline-block",style:"width: 10rem; color: "+t.getDarkColor(t.user.topic)},[t._v(t._s(n.major)+"."+t._s(n.minor)+"."+t._s(n.patch))]),e("strong",{staticClass:"grey--text"},[t._v("\u4E0A\u4F20\u4E8E\uFF1A"+t._s(n.time.toLocaleString()))]),e("v-spacer"),e("v-btn",{staticClass:"white--text",attrs:{color:t.getDarkColor(t.user.topic)},on:{click:()=>t.download(n)}},[t._v("\u4E0B\u8F7D")])],1)],1)]}}],null,!0)})],1)}),e("v-timeline-item",{attrs:{color:t.getTopicColor(t.user.topic),icon:"mdi-upload"}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function({hover:n}){return[e("v-card",{style:"transition-duration: 0.5s;"+(n?t.getLinearGradient(t.user.topic):""),on:{click:()=>t.initUploadDialog(i,a)}},[e("v-card-title",[e("strong",{staticClass:"d-inline-block",style:"width: 10rem; color: "+t.getDarkColor(t.user.topic)},[t._v("\u4E0A\u4F20\u65B0\u7248\u672C")]),e("v-spacer")],1)],1)]}}],null,!0)})],1)],2)],1)],1)])],1)]}}],null,!0)})],1)]}),e("v-col",{attrs:{cols:"4"}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function({hover:i}){return[e("v-card",{style:i?t.getRadialGradient(t.user.topic):"",attrs:{"min-height":"13rem","max-height":"13rem"},on:{click:()=>t.initUploadDialog(null)}},[e("v-card-title",[e("strong",{style:"color: "+t.getDarkColor(t.user.topic)},[t._v("\u521B\u5EFA\u65B0\u7684\u6587\u4EF6\u7CFB\u5217")])]),e("v-card-text",[t._v("\u4E0A\u4F20\u4E00\u4E2A\u6587\u4EF6\uFF0C\u4F7F\u7528\u7248\u672C\u4EE3\u7801\u5728JiHub\u4E0A\u6301\u7EED\u8FFD\u6EAF\uFF0C\u968F\u65F6\u4E0B\u8F7D\uFF0C\u9879\u76EE\u6210\u5458\u4E5F\u53EF\u4E0A\u4F20\u6700\u65B0\u8FDB\u5C55")]),e("v-card-actions",[e("v-spacer"),e("v-btn",{attrs:{plain:""},on:{click:()=>t.initUploadDialog(null)}},[t._v("\u5F00\u59CB")])],1)],1)]}}])})],1)],2),e("v-dialog",{attrs:{persistent:""},model:{value:t.uploadDialog,callback:function(i){t.uploadDialog=i},expression:"uploadDialog"}},[e("v-card",[e("v-card-title",[t._v("\u4E0A\u4F20\u6587\u4EF6")]),e("v-card-text",[e("v-form",[e("v-row",[e("v-col",{attrs:{cols:"6"}},[e("v-file-input",{attrs:{"truncate-length":"100","show-size":"",label:"\u4E0A\u4F20\u6587\u4EF6",outlined:""},on:{change:t.onFileInput},model:{value:t.fileInput,callback:function(i){t.fileInput=i},expression:"fileInput"}})],1),e("v-col",{attrs:{cols:"4"}},[e("v-scroll-y-transition",[t.fileInput?e("v-text-field",{attrs:{disabled:!t.changeNameAllow,label:"\u6587\u4EF6\u7CFB\u5217\u540D",rules:[i=>i.indexOf("-")===-1?!0:"\u6587\u4EF6\u540D\u4E0D\u5141\u8BB8\u6709'-'\u7B26\u53F7"],"prepend-icon":"mdi-file",counter:"16",outlined:""},model:{value:t.fileNameInput,callback:function(i){t.fileNameInput=i},expression:"fileNameInput"}}):t._e()],1)],1),e("v-col",{attrs:{cols:"2"}},[e("v-scroll-y-transition",[t.fileInput?e("v-text-field",{attrs:{disabled:!t.changeNameAllow,label:"\u6587\u4EF6\u62D3\u5C55\u540D",rules:[i=>i!=="",i=>i.indexOf(".")===-1?!0:"\u62D3\u5C55\u540D\u4E0D\u5141\u8BB8'.'\u7B26\u53F7"],"prepend-icon":"mdi-file",counter:"10",outlined:""},model:{value:t.fileExtInput,callback:function(i){t.fileExtInput=i},expression:"fileExtInput"}}):t._e()],1)],1)],1),e("v-row",[e("v-col",{attrs:{cols:"4"}},[e("v-scroll-y-transition",[t.fileInput&&t.fileNameInput!==""&&t.fileNameInput.indexOf("-")===-1&&t.fileNameInput.length<=16&&t.fileExtInput!==""&&t.fileExtInput.length<=10?e("v-text-field",{attrs:{label:"\u4E3B\u7248\u672C\u53F7",rules:[i=>i!=="",i=>i>=0?!0:"\u7248\u672C\u53F7\u5FC5\u987B\u4E3A\u6B63\u6574\u6570",i=>i!=="0"&&i.startsWith("0")?"\u4E0D\u5141\u8BB8\u524D\u5BFC\u96F6":!0,i=>i<=999?!0:"\u7248\u672C\u53F7\u592A\u5927\u4E86"],"prepend-icon":"mdi-file",counter:"3",outlined:""},model:{value:t.fileMajorInput,callback:function(i){t.fileMajorInput=i},expression:"fileMajorInput"}}):t._e()],1)],1),e("v-col",{attrs:{cols:"4"}},[e("v-scroll-y-transition",[t.fileInput&&t.fileNameInput!==""&&t.fileNameInput.indexOf("-")===-1&&t.fileNameInput.length<=16&&t.fileExtInput!==""&&t.fileExtInput.length<=10?e("v-text-field",{attrs:{label:"\u5C0F\u7248\u672C\u53F7",rules:[i=>i!=="",i=>i>=0?!0:"\u7248\u672C\u53F7\u5FC5\u987B\u4E3A\u6B63\u6574\u6570",i=>i!=="0"&&i.startsWith("0")?"\u4E0D\u5141\u8BB8\u524D\u5BFC\u96F6":!0,i=>i<=999?!0:"\u7248\u672C\u53F7\u592A\u5927\u4E86"],"prepend-icon":"mdi-file",counter:"3",outlined:""},model:{value:t.fileMinorInput,callback:function(i){t.fileMinorInput=i},expression:"fileMinorInput"}}):t._e()],1)],1),e("v-col",{attrs:{cols:"4"}},[e("v-scroll-y-transition",[t.fileInput&&t.fileNameInput!==""&&t.fileNameInput.indexOf("-")===-1&&t.fileNameInput.length<=16&&t.fileExtInput!==""&&t.fileExtInput.length<=10?e("v-text-field",{attrs:{label:"\u4FEE\u8BA2\u53F7",rules:[i=>i!=="",i=>i>=0?!0:"\u7248\u672C\u53F7\u5FC5\u987B\u4E3A\u6B63\u6574\u6570",i=>i!=="0"&&i.startsWith("0")?"\u4E0D\u5141\u8BB8\u524D\u5BFC\u96F6":!0,i=>i<=999?!0:"\u7248\u672C\u53F7\u592A\u5927\u4E86"],"prepend-icon":"mdi-file",counter:"3",outlined:""},model:{value:t.filePatchInput,callback:function(i){t.filePatchInput=i},expression:"filePatchInput"}}):t._e()],1)],1)],1)],1)],1),t.fileInput&&t.fileNameInput!==""&&t.fileNameInput.indexOf("-")===-1&&t.fileNameInput.length<=16&&t.fileExtInput!==""&&t.fileExtInput.length<=10?[e("v-card-text",[e("v-card-title",[e("strong",[t._v(t._s(t.fileNameInput)+"."+t._s(t.fileExtInput))])]),e("v-timeline",{attrs:{dense:""}},[t.changeNameAllow?t._e():e("v-timeline-item",{attrs:{color:t.getTopicColor(t.user.topic)}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function({hover:i}){return[e("v-card",{style:"transition-duration: 0.5s;"+(i?t.getLinearGradient(t.user.topic):"")},[e("v-card-title",[e("strong",{staticClass:"d-inline-block",style:"width: 15rem; color: "+t.getDarkColor(t.user.topic)},[t._v(t._s(Math.floor(t.minPatch/1e6))+"."+t._s(Math.floor(t.minPatch/1e3%1e3))+"."+t._s(t.minPatch%1e3))]),e("strong",{staticClass:"grey--text"},[t._v("\u6B64\u524D\u7684\u7248\u672C")]),e("v-spacer"),e("v-btn",{staticClass:"white--text",attrs:{color:t.getDarkColor(t.user.topic),disabled:""}},[t._v("\u4E0B\u8F7D\uFF08\u4E0D\u53EF\u7528\uFF09")])],1)],1)]}}],null,!1,48090339)})],1),e("v-timeline-item",{attrs:{color:t.getTopicColor(t.user.topic),icon:"mdi-upload"}},[e("v-hover",{scopedSlots:t._u([{key:"default",fn:function({hover:i}){return[e("v-card",{style:"transition-duration: 0.5s;"+(i?t.getLinearGradient(t.user.topic):"")},[e("v-card-title",[t.changeNameAllow||1e6*t.fileMajorInput+1e3*t.fileMinorInput+t.filePatchInput>t.minPatch?e("strong",{staticClass:"d-inline-block",style:"width: 15rem; color: "+t.getDarkColor(t.user.topic)},[t._v(t._s(t.fileMajorInput)+"."+t._s(t.fileMinorInput)+"."+t._s(t.filePatchInput))]):e("strong",{staticClass:"d-inline-block",style:"width: 15rem; color: red"},[t._v(t._s(t.fileMajorInput)+"."+t._s(t.fileMinorInput)+"."+t._s(t.filePatchInput)+"\uFF08\u8FC7\u65F6\u6216\u91CD\u590D\u7248\u672C\uFF09")]),e("strong",{staticClass:"grey--text"},[t._v("\u4E0A\u4F20\u4E8E\uFF1A"+t._s(new Date().toLocaleString()))]),e("v-spacer"),e("v-btn",{staticClass:"white--text",attrs:{color:t.getDarkColor(t.user.topic),disabled:""}},[t._v("\u4E0B\u8F7D\uFF08\u4E0D\u53EF\u7528\uFF09")])],1)],1)]}}],null,!1,1410110661)})],1)],1)],1)]:t._e(),e("v-card-actions",[e("v-spacer"),e("v-btn",{attrs:{plain:"",color:"red"},on:{click:function(i){t.uploadDialog=!t.uploadDialog}}},[t._v("\u53D6\u6D88")]),e("v-btn",{attrs:{plain:"",color:t.getDarkColor(t.user.topic),disabled:!(t.fileInput&&t.fileNameInput!==""&&t.fileNameInput.indexOf("-")===-1&&t.fileNameInput.length<=16&&t.fileExtInput!==""&&t.fileExtInput.length<=10&&t.fileExtInput.indexOf(".")===-1&&(t.changeNameAllow||1e6*t.fileMajorInput+1e3*t.fileMinorInput+t.filePatchInput>t.minPatch)&&0<=t.fileMajorInput&&t.fileMajorInput<=999&&0<=t.fileMinorInput&&t.fileMinorInput<=999&&0<=t.filePatchInput&&t.filePatchInput<=999&&!t.checkLeadingZero(t.fileMajorInput)&&!t.checkLeadingZero(t.fileMinorInput)&&!t.checkLeadingZero(t.filePatchInput))},on:{click:t.upload}},[t._v("\u786E\u5B9A\u4E0A\u4F20")])],1)],2)],1)],1)},h=[],g=p(d,f,h,!1,null,"39447c91",null,null);const I=g.exports;export{I as default};
