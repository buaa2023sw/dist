import{n as v,l as p,a as u,k as n}from"./index.28b13545.js";const h={name:"Chat",data(){return{selectedRoom:0,messageInput:"",chatRooms:[],createSheet:!1,inviteSheet:!1,createRoomName:"",createRoomDesc:"",projectPopulation:[],selectedPopulation:[],expelledPopulation:[],inviteNominees:p(()=>this.projectPopulation.filter((o,e)=>this.chatRooms[this.selectedRoom].users.find((t,s)=>t.userId===o.peopleId)===void 0)),inviteSelected:[]}},inject:{user:{default:null},proj:{default:null}},created(){this.updateChatRooms(),this.updatePopulation()},methods:{getIdenticon:u,updateChatRooms(){console.log("updating chat rooms...");let o={};this.chatRooms.forEach((e,t)=>{e.ws!==null&&(o[e.id]=e.ws)}),this.chatRooms=[],n.post("/api/chat/discussions",{projectId:this.proj.projectId,userId:this.user.id}).then(e=>{if(console.log(e.data),e.data.errcode===0){let t=e.data.data.discussions.map((a,i)=>({id:a.roomId,title:a.roomName,desc:a.outline,users:a.users,history:[]}));console.log(t);let s={};t.forEach((a,i)=>{s[a.id]===void 0&&(s[a.id]=a)}),this.chatRooms=Object.values(s),console.log(t)}else throw new Error("get discussion list failure with non 0 errcode ("+e.data.errcode+")")}).catch(e=>{this.chatRooms=[],console.error(e),this.$message({type:"error",message:"get discussion list failure with error: "+e})}).finally(()=>{this.chatRooms.forEach((e,t)=>{o[e.id]!==void 0?(e.ws=o[e.id],o[e.id]=void 0):(e.ws=this.initWS(e.id),this.getChatHistory(e))});for(const[e,t]of Object.entries(o))t!==void 0&&t.close()})},createChatRoom(){if(this.createRoomName===""){this.$message({type:"warning",message:"\u8BF7\u8F93\u5165\u804A\u5929\u5BA4\u540D\u79F0"});return}else if(this.createRoomDesc===""){this.$message({type:"warning",message:"\u8BF7\u8F93\u5165\u804A\u5929\u5BA4\u7B80\u4ECB"});return}let o=this.selectedPopulation.map((e,t)=>e.peopleId);n.post("/api/chat/createRoom",{projectId:this.proj.projectId,roomName:this.createRoomName,outline:this.createRoomDesc,currentUserId:this.user.id,users:o}).finally(()=>{this.updateChatRooms()}),this.createRoomName="",this.createRoomDesc="",this.selectedPopulation=[],this.expelledPopulation=this.projectPopulation,this.createSheet=!1},getChatHistory(o){n.post("/api/chat/getRoomMessages",{roomId:o.id}).then(e=>{if(console.log(e.data),e.data.errcode===0){e.data.data.messages.reverse().map((s,a)=>{o.history.push({from:s.senderName,content:s.content,time:s.time,type:"group"})});let t={};o.history.forEach((s,a)=>{t[s.time]===void 0&&(t[s.time]=s)}),o.history=Object.values(t)}else throw new Error("get room messages failure with non 0 errcode ("+e.data.errcode+")")}).catch(e=>{console.error(e),this.$message({type:"error",message:"get room messages failure with error: "+e})})},inviteUserToChat(o,e){n.post("/api/chat/addPerson",{roomId:o,userId:e}).then(t=>{console.log(t)}).finally(()=>{this.inviteSheet=!1,this.updateChatRooms()})},updatePopulation(){n.post("/api/plan/showPersonList",{projectId:this.proj.projectId,userId:this.user.id}).then(o=>{if(o.data.errcode!==0)throw new Error("get person list failure with non 0 errcode ("+o.data.errcode+")");this.projectPopulation=o.data.data.filter((e,t)=>e.peopleId!==this.user.id),this.expelledPopulation=o.data.data.filter((e,t)=>e.peopleId!==this.user.id),console.log(o.data.data)}).catch(o=>{console.error(o),this.$message({type:"error",message:"get person list failure with error: "+o})})},initWS(o){console.log("initWS: connecting to ws://104.208.78.33:8000/ws/chat/"+this.user.id.toString()+"/"+o.toString());const e=new WebSocket("ws://104.208.78.33:8000/ws/chat/"+this.user.id.toString()+"/"+o.toString()),t=a=>{console.log("socket opened")};e.onopen=t;const s=(a,i,l,c)=>{let r=this.chatRooms.find((d,_)=>d.id===o);r===void 0?console.error("room not found"):r.history.splice(0,0,{from:a,type:"group",content:l,time:c})};return e.onmessage=function(a){console.log("Message from server ",a.data);var i=JSON.parse(a.data);s(i.senderName,i.senderId,i.content,i.time)},e.onerror=function(a){console.error("WebSocket error observed:",a)},e.onclose=function(a){console.log("Socket is closed.",a.reason)},e},sendMsg(){if((this.messageInput||"").length>80){this.$message({type:"error",message:"\u6D88\u606F\u592A\u957F\u4E86"});return}console.log("will send: "+this.messageInput),this.chatRooms[this.selectedRoom].ws.send(JSON.stringify({sender:this.user.id,type:1,message:this.messageInput})),this.messageInput=""}},beforeRouteLeave(o,e,t){console.log("leaving chat room, closing all ws"),this.chatRooms.forEach((s,a)=>{s.ws.close()}),t()}};var m=function(){var e=this,t=e._self._c;return t("v-container",[t("h1",[e._v("\u804A\u5929\u5BA4")]),t("v-row",[t("v-col",{attrs:{cols:"3"}},[t("v-list",[t("v-list-item-group",{attrs:{mandatory:""},model:{value:e.selectedRoom,callback:function(s){e.selectedRoom=s},expression:"selectedRoom"}},e._l(e.chatRooms,function(s){return t("v-list-item",{key:s.id,attrs:{"two-line":""}},[t("v-list-item-content",[t("v-list-item-title",{staticStyle:{"font-weight":"bold"}},[e._v(e._s(s.title)+" "),t("span",{staticClass:"float-end grey--text"},[e._v(e._s(s.desc))])]),t("v-list-item-subtitle",[e._v(" "+e._s(s.history.length===0?"\u8FD8\u6CA1\u6709\u6D88\u606F\u54E6":s.history[0].from+" : "+s.history[0].content)+" "),t("span",{staticClass:"float-end"},[e._v(e._s(s.history.length===0?"":new Date(s.history[0].time).toLocaleTimeString()))])])],1)],1)}),1),t("v-divider"),t("v-list-item",{attrs:{ripple:""},on:{click:function(s){e.createSheet=!e.createSheet}}},[t("v-list-item-content",[e._v("\u521B\u5EFA\u65B0\u7684\u804A\u5929\u5BA4")]),t("v-list-item-icon",[t("v-icon",[e._v("mdi-plus-circle")])],1)],1),t("v-dialog",{model:{value:e.createSheet,callback:function(s){e.createSheet=s},expression:"createSheet"}},[t("v-card",[t("v-card-title",[e._v(" \u521B\u5EFA\u65B0\u7684\u804A\u5929\u5BA4 ")]),t("v-card-text",[t("v-row",[t("v-spacer"),t("v-col",{attrs:{cols:"5"}},[t("v-text-field",{attrs:{label:"\u804A\u5929\u5BA4\u540D\u79F0"},model:{value:e.createRoomName,callback:function(s){e.createRoomName=s},expression:"createRoomName"}})],1),t("v-col",{attrs:{cols:"5"}},[t("v-text-field",{attrs:{label:"\u804A\u5929\u5BA4\u7B80\u4ECB"},model:{value:e.createRoomDesc,callback:function(s){e.createRoomDesc=s},expression:"createRoomDesc"}})],1),t("v-spacer")],1),t("v-row",[t("v-spacer"),t("v-col",{attrs:{cols:"5"}},[e._v(" \u4ECE\u53F3\u8FB9\u9009\u62E9\u804A\u5929\u5BA4\u6210\u5458 "),t("v-chip",{staticClass:"ma-2 accent-1",attrs:{pill:"",color:"green"},on:{click:()=>{this.$message({type:"error",message:"\u628A\u81EA\u5DF1\u8E22\u51FA\u804A\u5929\u5BA4\uFF0C\u8FD9\u4E5F\u592A\u72E0\u4E86\uFF01"})}}},[t("v-avatar",{attrs:{left:""}},[t("v-img",{attrs:{src:e.getIdenticon(e.user.name,50,"user")}})],1),e._v(" \u60A8 ")],1),e._l(e.selectedPopulation,function(s){return t("v-chip",{key:s.peopleId,staticClass:"ma-2 accent-1",attrs:{color:"green"},on:{click:()=>{e.expelledPopulation.push(s),e.selectedPopulation.splice(e.selectedPopulation.indexOf(s),1)}}},[t("v-avatar",{attrs:{left:""}},[t("v-img",{attrs:{src:e.getIdenticon(s.peopleName,50,"user")}})],1),e._v(" "+e._s(s.peopleName)+" ")],1)})],2),t("v-col",{attrs:{cols:"5"}},[e.expelledPopulation.length!==0?t("span",[e._v("\u4E0D\u5728\u804A\u5929\u5BA4\u7684\u6210\u5458\uFF1A")]):t("span",[e._v("\u5927\u5BB6\u90FD\u5728\u804A\u5929\u5BA4\u91CC\u4E86\u54E6")]),e._l(e.expelledPopulation,function(s){return t("v-chip",{key:s.peopleId,staticClass:"ma-2",on:{click:()=>{e.selectedPopulation.push(s),e.expelledPopulation.splice(e.expelledPopulation.indexOf(s),1)}}},[t("v-avatar",{attrs:{left:""}},[t("v-img",{attrs:{src:e.getIdenticon(s.peopleName,50,"user")}})],1),e._v(" "+e._s(s.peopleName)+" ")],1)})],2),t("v-spacer")],1)],1),t("v-card-actions",[t("v-spacer"),t("v-btn",{staticClass:"green--text",attrs:{plain:""},on:{click:e.createChatRoom}},[e._v("\u521B\u5EFA\uFF01")])],1)],1)],1)],1)],1),t("v-col",{attrs:{cols:"9"}},[e.chatRooms.length>0?t("v-row",[t("v-col",{attrs:{cols:"12"}},[t("v-card",[t("v-card-title",{staticClass:"v-app-bar-title"},[e._v(e._s(e.chatRooms[e.selectedRoom].title))]),t("v-card-subtitle",[this.chatRooms[this.selectedRoom].ws!==void 0&&this.chatRooms[this.selectedRoom].ws.readyState===1?t("v-icon",{staticClass:"green--text"},[e._v("mdi-circle")]):t("v-icon",{staticClass:"yellow--text"},[e._v("mdi-circle")]),e._v(" ws://104.208.78.33:8000/ws/chat/"+e._s(this.user.id)+"/"+e._s(e.chatRooms[e.selectedRoom].id)+" | "+e._s(e.chatRooms[e.selectedRoom].desc)+" ")],1),t("v-card-text",[e._l(e.chatRooms[e.selectedRoom].users,function(s){return t("v-hover",{key:s.userId,scopedSlots:e._u([{key:"default",fn:function({hover:a}){return[t("span",[t("v-avatar",{staticClass:"mx-1",attrs:{size:"50px"}},[t("v-img",{attrs:{alt:s.username,src:e.getIdenticon(s.userName,50,"user")}})],1),t("Transition",[a?t("p",{staticClass:"px-2 text-h5 d-inline-block",staticStyle:{"font-weight":"bold"}},[e._v(e._s(s.userName))]):e._e()])],1)]}}],null,!0)})}),t("v-avatar",{staticClass:"mx-1 float-end"},[t("v-icon",{attrs:{size:"50px"},on:{click:function(s){e.inviteSheet=!e.inviteSheet}}},[e._v("mdi-plus-circle")])],1)],2)],1)],1),t("v-dialog",{model:{value:e.inviteSheet,callback:function(s){e.inviteSheet=s},expression:"inviteSheet"}},[t("v-card",[t("v-card-title",[e._v("\u9080\u8BF7\u65B0\u6210\u5458\u52A0\u5165\u804A\u5929\u5BA4")]),e.inviteNominees.length!==0?t("v-card-text",[t("v-chip-group",{attrs:{mandatory:"","active-class":"primary--text"},model:{value:e.inviteSelected,callback:function(s){e.inviteSelected=s},expression:"inviteSelected"}},e._l(e.inviteNominees,function(s){return t("v-chip",{key:s.peopleId,staticClass:"ma-2",on:{click:()=>{e.expelledPopulation.push(s),e.selectedPopulation.splice(e.selectedPopulation.indexOf(s),1)}}},[t("v-avatar",{attrs:{left:""}},[t("v-img",{attrs:{src:e.getIdenticon(s.peopleName,50,"user")}})],1),e._v(" "+e._s(s.peopleName)+" ")],1)}),1),t("v-divider"),e.inviteNominees[e.inviteSelected]!==void 0?t("v-card-subtitle",[e._v("\u8981\u9080\u8BF7 "+e._s(e.inviteNominees[e.inviteSelected].peopleName)+" \u8FDB\u5165\u7FA4\u804A\u201C"+e._s(e.chatRooms[e.selectedRoom].title)+"\u201D\u5417\uFF1F")]):e._e(),t("v-card-actions",[t("v-btn",{staticClass:"green--text",attrs:{plain:""},on:{click:()=>e.inviteUserToChat(e.chatRooms[e.selectedRoom].id,e.inviteNominees[e.inviteSelected].peopleId)}},[e._v("\u786E\u5B9A\u9080\u8BF7")]),t("v-btn",{staticClass:"red--text",attrs:{plain:""},on:{click:()=>e.inviteSheet=!e.inviteSheet}},[e._v("\u6211\u518D\u60F3\u60F3")])],1)],1):t("v-card-text",[t("v-card-subtitle",[e._v("\u9879\u76EE\u6240\u6709\u7684\u6210\u5458\u90FD\u5728\u804A\u5929\u5BA4\u91CC\u4E86\uFF01")]),t("v-card-actions",[t("v-btn",{staticClass:"green--text",attrs:{plain:""},on:{click:()=>e.inviteSheet=!e.inviteSheet}},[e._v("\u597D")])],1)],1)],1)],1)],1):e._e(),e.chatRooms.length>0?t("v-row",[t("v-col",{attrs:{cols:"12"}},[t("v-card",[t("v-card-text",[t("v-row",[t("v-spacer"),t("v-col",{attrs:{cols:"10"}},[t("v-text-field",{attrs:{rounded:"",filled:"",counter:"80",label:"\u8F93\u5165\u6D88\u606F","append-outer-icon":"mdi-send"},on:{"click:append-outer":e.sendMsg,keydown:function(s){return!s.type.indexOf("key")&&e._k(s.keyCode,"enter",13,s.key,"Enter")?null:e.sendMsg.apply(null,arguments)}},model:{value:e.messageInput,callback:function(s){e.messageInput=s},expression:"messageInput"}})],1),t("v-spacer")],1),t("v-list",{staticClass:"overflow-auto scroll-y",attrs:{"min-height":"600","max-height":"600"}},[t("v-list-item-group",[e._l(e.chatRooms[e.selectedRoom].history,function(s){return[t("v-divider",{key:s.id}),t("v-list-item",{key:s.id,attrs:{disabled:"","two-line":""}},[e.user.name!==s.from?t("v-list-item-avatar",{attrs:{size:"40px"}},[t("v-img",{attrs:{src:e.getIdenticon(s.from,50,"user")}})],1):e._e(),e.user.name!==s.from?t("v-list-item-content",[t("v-list-item-title",{staticClass:"text--primary",staticStyle:{"font-weight":"bold","font-size":"large"}},[e._v(e._s(s.content))]),t("v-list-item-subtitle",[e._v(e._s(s.from)),t("span",{staticClass:"float-end"},[e._v(e._s(new Date(s.time).toLocaleTimeString()))])])],1):e._e(),e.user.name===s.from?t("v-list-item-content",[t("v-list-item-title",{staticClass:"text--primary",staticStyle:{"font-weight":"bold","font-size":"large"}},[t("span",{staticClass:"float-end"},[e._v(e._s(s.content))])]),t("v-list-item-subtitle",[e._v(e._s(new Date(s.time).toLocaleTimeString())),t("span",{staticClass:"float-end"},[e._v("\u60A8")])])],1):e._e(),e.user.name===s.from?t("v-list-item-avatar",{attrs:{size:"40px"}},[t("v-img",{attrs:{src:e.getIdenticon(s.from,50,"user")}})],1):e._e()],1)]})],2)],1)],1)],1)],1)],1):t("v-row",[t("v-col",{attrs:{cols:"12"}},[t("v-card",[t("v-card-title",[e._v("\u8FD8\u6CA1\u6709\u8BA8\u8BBA\u5BA4\u54E6")]),t("v-card-text",[t("v-card-actions",[t("v-btn",{staticClass:"green--text accent-1",attrs:{plain:""},on:{click:function(s){e.createSheet=!e.createSheet}}},[e._v("\u53BB\u521B\u5EFA\uFF01")])],1)],1)],1)],1)],1)],1)],1)],1)},f=[],g=v(h,m,f,!1,null,null,null,null);const R=g.exports;export{R as default};
