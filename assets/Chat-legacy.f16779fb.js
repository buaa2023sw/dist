!function(){function e(e,o){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var o=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=o){var s,i,a,n,r=[],c=!0,l=!1;try{if(a=(o=o.call(e)).next,0===t){if(Object(o)!==o)return;c=!1}else for(;!(c=(s=a.call(o)).done)&&(r.push(s.value),r.length!==t);c=!0);}catch(d){l=!0,i=d}finally{try{if(!c&&null!=o.return&&(n=o.return(),Object(n)!==n))return}finally{if(l)throw i}}return r}}(e,o)||function(e,o){if(!e)return;if("string"==typeof e)return t(e,o);var s=Object.prototype.toString.call(e).slice(8,-1);"Object"===s&&e.constructor&&(s=e.constructor.name);if("Map"===s||"Set"===s)return Array.from(e);if("Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return t(e,o)}(e,o)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,s=new Array(t);o<t;o++)s[o]=e[o];return s}System.register(["./index-legacy.597d940a.js"],(function(t,o){"use strict";var s,i,a,n,r,c=document.createElement("style");return c.textContent=".v-enter-active{animation:slideInLeft-enter .3s}.v-leave-active{animation:slideInLeft-enter .3s reverse}@keyframes slideInLeft-enter{0%{opacity:0%;transform:translate(-100%)}to{opacity:100%;transform:translate(0)}}\n",document.head.appendChild(c),{setters:[function(e){s=e.n,i=e.o,a=e.a,n=e.l,r=e.t}],execute:function(){var o={name:"Chat",data:function(){var e=this;return{selectedRoom:0,messageInput:"",chatRooms:[],createSheet:!1,inviteSheet:!1,expelSheet:!1,createRoomName:"",createRoomDesc:"",projectPopulation:[],selectedPopulation:[],expelledPopulation:[],inviteNominees:i((function(){return e.projectPopulation.filter((function(t,o){return void 0===e.chatRooms[e.selectedRoom].users.find((function(e,o){return e.userId===t.peopleId}))}))})),inviteSelected:[],messageServiceAvailable:!1}},inject:{user:{default:null},proj:{default:null}},created:function(){this.updateChatRooms(),this.updatePopulation(),this.initMessagingService()},methods:{getIdenticon:a,updateChatRooms:function(){var t=this;console.log("updating chat rooms...");var o={},s={};this.chatRooms.forEach((function(e,t){null!==e.ws&&(o[e.id]=e.ws,s[e.id]=e.history)})),this.chatRooms=[],n.post("/api/chat/discussions",{projectId:this.proj.projectId,userId:this.user.id}).then((function(e){if(console.log(e.data),0!==e.data.errcode)throw new Error("get discussion list failure with non 0 errcode ("+e.data.errcode+")");var o=e.data.data.discussions.map((function(e,t){return{id:e.roomId,title:e.roomName,desc:e.outline,users:e.users,history:[],selectedUser:null}}));console.log(o);var s={};o.forEach((function(e,t){void 0===s[e.id]&&(s[e.id]=e)})),t.chatRooms=Object.values(s),console.log(o),t.selectedRoom=0})).catch((function(e){t.chatRooms=[],console.error(e),t.$message({type:"error",message:"get discussion list failure with error: "+e})})).finally((function(){t.chatRooms.forEach((function(e,i){void 0!==o[e.id]?(e.ws=o[e.id],o[e.id]=void 0,e.history=s[e.id]):(e.ws=t.initWS(e.id),t.getChatHistory(e))}));for(var i=0,a=Object.entries(o);i<a.length;i++){var n=e(a[i],2),r=(n[0],n[1]);void 0!==r&&r.close()}}))},createChatRoom:function(){var e=this;if(""!==this.createRoomName)if(""!==this.createRoomDesc){var t=this.selectedPopulation.map((function(e,t){return e.peopleId}));n.post("/api/chat/createRoom",{projectId:this.proj.projectId,roomName:this.createRoomName,outline:this.createRoomDesc,currentUserId:this.user.id,users:t}).finally((function(){e.updateChatRooms()})),this.createRoomName="",this.createRoomDesc="",this.selectedPopulation=[],this.expelledPopulation=this.projectPopulation,this.createSheet=!1}else this.$message({type:"warning",message:"请输入聊天室简介"});else this.$message({type:"warning",message:"请输入聊天室名称"})},getChatHistory:function(e){var t=this;n.post("/api/chat/getRoomMessages",{roomId:e.id}).then((function(t){if(console.log(t.data),e.history=[],0!==t.data.errcode)throw new Error("get room messages failure with non 0 errcode ("+t.data.errcode+")");t.data.data.messages.reverse().map((function(t,o){e.history.push({from:t.senderName,content:t.content,time:t.time,type:"group"})}));var o={};e.history.forEach((function(e,t){void 0===o[e.time]&&(o[e.time]=e)})),e.history=Object.values(o)})).catch((function(e){console.error(e),t.$message({type:"error",message:"get room messages failure with error: "+e})}))},inviteUserToChat:function(e,t){var o=this;n.post("/api/chat/addPerson",{roomId:e,userId:t}).then((function(e){console.log(e)})).finally((function(){o.messageInput="".concat(o.user.name)+"邀请"+"".concat(o.inviteNominees[o.inviteSelected].peopleName)+"加入了聊天室",o.sendMsg(),setTimeout((function(){o.updateChatRooms(),o.inviteSheet=!1}),2e3)}))},updatePopulation:function(){var e=this;n.post("/api/plan/showPersonList",{projectId:this.proj.projectId,userId:this.user.id}).then((function(t){if(0!==t.data.errcode)throw new Error("get person list failure with non 0 errcode ("+t.data.errcode+")");e.projectPopulation=t.data.data.filter((function(t,o){return t.peopleId!==e.user.id})),e.expelledPopulation=t.data.data.filter((function(t,o){return t.peopleId!==e.user.id})),console.log(t.data.data)})).catch((function(t){console.error(t),e.$message({type:"error",message:"get person list failure with error: "+t})}))},initWS:function(e){var t=this;console.log("initWS: connecting to ws://104.208.78.33:8000/ws/chat/"+this.user.id.toString()+"/"+e.toString());var o=new WebSocket("ws://104.208.78.33:8000/ws/chat/"+this.user.id.toString()+"/"+e.toString());o.onopen=function(e){console.log("socket opened")};return o.onmessage=function(o){console.log("Message from server ",o.data);var s,i,n,r,c=JSON.parse(o.data);s=c.senderName,c.senderId,i=c.content,n=c.time,void 0===(r=t.chatRooms.find((function(t,o){return t.id===e})))?console.error("room not found"):(r.history.splice(0,0,{from:s,type:"group",content:i,time:n}),t.messageServiceAvailable&&"hidden"===document.visibilityState&&s!==t.user.name&&new Notification("来自讨论室 ".concat(r.title," 的一条新消息"),{body:"".concat(s,": ").concat(i),icon:a(s,100,"user")}))},o.onerror=function(e){console.error("WebSocket error observed:",e)},o.onclose=function(e){console.log("Socket is closed.",e.reason)},o},sendMsg:function(){(this.messageInput||"").length>80?this.$message({type:"error",message:"消息太长了"}):(console.log("will send: "+this.messageInput),this.chatRooms[this.selectedRoom].ws.send(JSON.stringify({sender:this.user.id,type:1,message:this.messageInput})),this.messageInput="")},initMessagingService:function(){var e=this;"Notification"in window&&(console.log("Notification is supported, initing messaging service"),Notification.requestPermission().then((function(t){"granted"===t?(console.log("Notification permission granted"),e.messageServiceAvailable=!0,new Notification("已注册消息通知",{icon:"../../favicon.ico",body:"消息通知已开启，JiHub会在收到新消息时显示提醒"})):(console.log("Notification permission denied"),e.messageServiceAvailable=!1)})))},expelUser:function(e,t){var o=this;console.log(e,t),n.post("/api/chat/deletePerson",{userId:t.userId,roomId:e.id}).finally((function(){o.messageInput="".concat(o.user.name)+"将"+"".concat(t.userName)+"移出了讨论室",o.sendMsg(),setTimeout((function(){o.updateChatRooms(),o.expelSheet=!1}),2e3)}))},getDarkColor:r.getDarkColor,getTopicColor:r.getColor,getLinearGradient:r.getLinearGradient,getRadialGradient:r.getRadialGradient},beforeRouteLeave:function(e,t,o){console.log("leaving chat room, closing all ws"),this.chatRooms.forEach((function(e,t){e.ws.close()})),o()}},c=function(){var e=this,t=this,o=t._self._c;return o("v-container",[o("h1",[t._v("聊天室")]),o("v-row",[o("v-col",{attrs:{cols:"3"}},[o("v-list",[o("v-list-item-group",{attrs:{mandatory:""},model:{value:t.selectedRoom,callback:function(e){t.selectedRoom=e},expression:"selectedRoom"}},t._l(t.chatRooms,(function(e){return o("v-list-item",{key:e.id,attrs:{"two-line":""}},[o("v-list-item-content",[o("v-list-item-title",{staticStyle:{"font-weight":"bold"}},[o("span",{style:"color: "+t.getDarkColor(t.user.topic)},[t._v(t._s(e.title))]),t._v(" "),o("span",{staticClass:"float-end grey--text"},[t._v(t._s(e.desc))])]),o("v-list-item-subtitle",[t._v(" "+t._s(0===e.history.length?"还没有消息哦":e.history[0].from+" : "+e.history[0].content)+" "),o("span",{staticClass:"float-end"},[t._v(t._s(0===e.history.length?"":new Date(e.history[0].time).toLocaleTimeString()))])])],1)],1)})),1),o("v-divider"),o("v-list-item",{attrs:{ripple:""},on:{click:function(e){t.createSheet=!t.createSheet}}},[o("v-list-item-content",[o("span",{style:"color: "+t.getDarkColor(t.user.topic)},[t._v("创建新的聊天室")])]),o("v-list-item-icon",[o("v-icon",{attrs:{color:t.getDarkColor(t.user.topic)}},[t._v("mdi-plus-circle")])],1)],1),o("v-dialog",{model:{value:t.createSheet,callback:function(e){t.createSheet=e},expression:"createSheet"}},[o("v-card",[o("v-card-title",[t._v(" 创建新的聊天室 ")]),o("v-card-text",[o("v-row",[o("v-spacer"),o("v-col",{attrs:{cols:"5"}},[o("v-text-field",{attrs:{label:"聊天室名称"},model:{value:t.createRoomName,callback:function(e){t.createRoomName=e},expression:"createRoomName"}})],1),o("v-col",{attrs:{cols:"5"}},[o("v-text-field",{attrs:{label:"聊天室简介"},model:{value:t.createRoomDesc,callback:function(e){t.createRoomDesc=e},expression:"createRoomDesc"}})],1),o("v-spacer")],1),o("v-row",[o("v-spacer"),o("v-col",{attrs:{cols:"5"}},[t._v(" 从右边选择聊天室成员 "),o("v-chip",{staticClass:"ma-2 accent-1",attrs:{pill:"",color:"green"},on:{click:function(){e.$message({type:"error",message:"把自己踢出聊天室，这也太狠了！"})}}},[o("v-avatar",{attrs:{left:""}},[o("v-img",{attrs:{src:t.getIdenticon(t.user.name,50,"user")}})],1),t._v(" 您 ")],1),t._l(t.selectedPopulation,(function(e){return o("v-chip",{key:e.peopleId,staticClass:"ma-2 accent-1",attrs:{color:"green"},on:{click:function(){t.expelledPopulation.push(e),t.selectedPopulation.splice(t.selectedPopulation.indexOf(e),1)}}},[o("v-avatar",{attrs:{left:""}},[o("v-img",{attrs:{src:t.getIdenticon(e.peopleName,50,"user")}})],1),t._v(" "+t._s(e.peopleName)+" ")],1)}))],2),o("v-col",{attrs:{cols:"5"}},[0!==t.expelledPopulation.length?o("span",[t._v("不在聊天室的成员：")]):o("span",[t._v("大家都在聊天室里了哦")]),t._l(t.expelledPopulation,(function(e){return o("v-chip",{key:e.peopleId,staticClass:"ma-2",on:{click:function(){t.selectedPopulation.push(e),t.expelledPopulation.splice(t.expelledPopulation.indexOf(e),1)}}},[o("v-avatar",{attrs:{left:""}},[o("v-img",{attrs:{src:t.getIdenticon(e.peopleName,50,"user")}})],1),t._v(" "+t._s(e.peopleName)+" ")],1)}))],2),o("v-spacer")],1)],1),o("v-card-actions",[o("v-spacer"),o("v-btn",{attrs:{plain:"",color:t.getDarkColor(t.user.topic)},on:{click:t.createChatRoom}},[t._v("创建！")])],1)],1)],1)],1)],1),o("v-col",{attrs:{cols:"9"}},[t.chatRooms.length>0?o("v-row",[o("v-col",{attrs:{cols:"12"}},[o("v-card",[o("v-card-title",{staticClass:"v-app-bar-title"},[t._v(t._s(t.chatRooms[t.selectedRoom].title))]),o("v-card-subtitle",[void 0!==this.chatRooms[this.selectedRoom].ws&&1===this.chatRooms[this.selectedRoom].ws.readyState?o("v-icon",{staticClass:"green--text"},[t._v("mdi-circle")]):o("v-icon",{staticClass:"yellow--text"},[t._v("mdi-circle")]),t._v(" "+t._s(""===t.chatRooms[t.selectedRoom].desc?"这个聊天室没有简介哦":t.chatRooms[t.selectedRoom].desc)+" | "+t._s(t.chatRooms[t.selectedRoom].users.length)+" 名成员 ")],1),o("v-card-text",[t._l(t.chatRooms[t.selectedRoom].users,(function(e){return o("span",{key:e.userId},[o("v-btn",{attrs:{fab:""},on:{click:function(o){t.chatRooms[t.selectedRoom].selectedUser=t.chatRooms[t.selectedRoom].selectedUser===e?null:e}}},[o("v-avatar",{staticClass:"mx-1",attrs:{size:"50px"}},[o("v-img",{attrs:{alt:e.username,src:t.getIdenticon(e.userName,50,"user")}})],1)],1)],1)})),o("v-avatar",{staticClass:"mx-1 float-end"},[o("v-icon",{attrs:{size:"50px",color:t.getDarkColor(t.user.topic)},on:{click:function(e){t.inviteSheet=!t.inviteSheet}}},[t._v("mdi-plus-circle")])],1)],2),o("v-expand-transition",[null!==t.chatRooms[t.selectedRoom].selectedUser?o("div",[o("v-divider"),o("v-card-actions",[o("v-avatar",{staticClass:"mx-1",attrs:{size:"50px"}},[o("v-img",{attrs:{src:t.getIdenticon(t.chatRooms[t.selectedRoom].selectedUser.userName,50,"user")}})],1),o("strong",[t._v(t._s(t.chatRooms[t.selectedRoom].selectedUser.userName))]),o("strong",[t._v(t._s(t.chatRooms[t.selectedRoom].selectedUser.userName===this.user.name?"（您自己）":""))]),o("v-spacer"),t.chatRooms[t.selectedRoom].selectedUser.userName!==this.user.name?o("v-btn",{staticClass:"white--text",attrs:{color:"red"},on:{click:function(e){t.expelSheet=!t.expelSheet}}},[o("v-icon",[t._v("mdi-alert")]),t._v("移除群聊")],1):t._e()],1)],1):t._e()])],1)],1),o("v-bottom-sheet",{attrs:{inset:""},model:{value:t.expelSheet,callback:function(e){t.expelSheet=e},expression:"expelSheet"}},[null!==t.chatRooms[t.selectedRoom].selectedUser?o("v-card",[o("v-card-title",[t._v("删除成员确认")]),o("v-card-text",[t._v("警告！这样做会导致成员 "+t._s(t.chatRooms[t.selectedRoom].selectedUser.userName)+" 无法访问聊天室“"+t._s(t.chatRooms[t.selectedRoom].title)+"”。您确定要删除成员 "+t._s(t.chatRooms[t.selectedRoom].selectedUser.userName)+" 吗？")]),o("v-card-actions",[t._v(" "+t._s(t.chatRooms[t.selectedRoom].selectedUser)+" "),o("v-spacer"),o("v-btn",{staticClass:"white--text",attrs:{color:"green"},on:{click:function(e){t.expelSheet=!t.expelSheet}}},[t._v("再想想")]),o("v-btn",{staticClass:"white--text",attrs:{color:"red"},on:{click:function(){return t.expelUser(t.chatRooms[t.selectedRoom],t.chatRooms[t.selectedRoom].selectedUser)}}},[o("v-icon",[t._v("mdi-alert")]),t._v("我确定")],1)],1),o("div",{staticStyle:{height:"50vh"}})],1):t._e()],1),o("v-dialog",{model:{value:t.inviteSheet,callback:function(e){t.inviteSheet=e},expression:"inviteSheet"}},[o("v-card",[o("v-card-title",[t._v("邀请新成员加入聊天室")]),0!==t.inviteNominees.length?o("v-card-text",[o("v-chip-group",{attrs:{mandatory:"","active-class":"primary--text"},model:{value:t.inviteSelected,callback:function(e){t.inviteSelected=e},expression:"inviteSelected"}},t._l(t.inviteNominees,(function(e){return o("v-chip",{key:e.peopleId,staticClass:"ma-2",on:{click:function(){t.expelledPopulation.push(e),t.selectedPopulation.splice(t.selectedPopulation.indexOf(e),1)}}},[o("v-avatar",{attrs:{left:""}},[o("v-img",{attrs:{src:t.getIdenticon(e.peopleName,50,"user")}})],1),t._v(" "+t._s(e.peopleName)+" ")],1)})),1),o("v-divider"),void 0!==t.inviteNominees[t.inviteSelected]?o("v-card-subtitle",[t._v("要邀请 "+t._s(t.inviteNominees[t.inviteSelected].peopleName)+" 进入群聊“"+t._s(t.chatRooms[t.selectedRoom].title)+"”吗？")]):t._e(),o("v-card-actions",[o("v-btn",{attrs:{plain:"",color:t.getDarkColor(t.user.topic)},on:{click:function(){return t.inviteUserToChat(t.chatRooms[t.selectedRoom].id,t.inviteNominees[t.inviteSelected].peopleId)}}},[t._v("确定邀请")]),o("v-btn",{staticClass:"red--text",attrs:{plain:""},on:{click:function(){return t.inviteSheet=!t.inviteSheet}}},[t._v("我再想想")])],1)],1):o("v-card-text",[o("v-card-subtitle",[t._v("项目所有的成员都在聊天室里了！")]),o("v-card-actions",[o("v-btn",{attrs:{plain:"",color:t.getDarkColor(t.user.topic)},on:{click:function(){return t.inviteSheet=!t.inviteSheet}}},[t._v("好")])],1)],1)],1)],1)],1):t._e(),t.chatRooms.length>0?o("v-row",[o("v-col",{attrs:{cols:"12"}},[o("v-card",[o("v-card-text",[o("v-row",[o("v-spacer"),o("v-col",{attrs:{cols:"10"}},[o("v-text-field",{attrs:{rounded:"",filled:"",counter:"80",label:"输入消息","append-outer-icon":"mdi-send"},on:{"click:append-outer":t.sendMsg,keydown:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.sendMsg.apply(null,arguments)}},model:{value:t.messageInput,callback:function(e){t.messageInput=e},expression:"messageInput"}})],1),o("v-spacer")],1),o("v-list",{staticClass:"overflow-auto scroll-y",attrs:{"min-height":"600","max-height":"600"}},[o("v-list-item-group",[t._l(t.chatRooms[t.selectedRoom].history,(function(e){return[o("v-divider",{key:e.id}),t.user.name!==e.from?o("v-list-item",{key:e.id,attrs:{disabled:"","two-line":""}},[o("v-list-item-avatar",{attrs:{size:"40px"}},[o("v-img",{attrs:{src:t.getIdenticon(e.from,50,"user")}})],1),o("v-list-item-content",[o("v-list-item-title",{staticClass:"text--primary",staticStyle:{"font-weight":"bold","font-size":"large"}},[t._v(t._s(e.content))]),o("v-list-item-subtitle",[t._v(t._s(e.from)),o("span",{staticClass:"float-end"},[t._v(t._s(new Date(e.time).getDate()===(new Date).getDate()?new Date(e.time).toLocaleTimeString():new Date(e.time).toLocaleString()))])])],1)],1):o("v-list-item",{key:e.id,style:t.getLinearGradient(t.user.topic),attrs:{disabled:"","two-line":""}},[o("v-list-item-content",[o("v-list-item-title",{staticClass:"text--primary",staticStyle:{"font-weight":"bold","font-size":"large"}},[o("span",{staticClass:"float-end"},[t._v(t._s(e.content))])]),o("v-list-item-subtitle",[t._v(t._s(new Date(e.time).getDate()===(new Date).getDate()?new Date(e.time).toLocaleTimeString():new Date(e.time).toLocaleString())),o("span",{staticClass:"float-end"},[t._v("您")])])],1),o("v-list-item-avatar",{attrs:{size:"40px"}},[o("v-img",{attrs:{src:t.getIdenticon(e.from,50,"user")}})],1)],1)]}))],2)],1)],1)],1)],1)],1):o("v-row",[o("v-col",{attrs:{cols:"12"}},[o("v-card",[o("v-card-title",[t._v("还没有讨论室哦")]),o("v-card-text",[o("v-card-actions",[o("v-btn",{staticClass:"green--text accent-1",attrs:{plain:""},on:{click:function(e){t.createSheet=!t.createSheet}}},[t._v("去创建！")])],1)],1)],1)],1)],1)],1)],1)],1)};t("default",s(o,c,[],!1,null,null,null,null).exports)}}}))}();
